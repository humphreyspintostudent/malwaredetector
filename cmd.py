import joblib
import os
import pickle
from peparser import PEParser
import argparse

CLASSIFIER_PKL = 'classifier/classifier.pkl'

def scan_file(filename):
    legitimate = True
    pe = PEParser(filename)

    clf = joblib.load(CLASSIFIER_PKL)
    features = pickle.loads(open('classifier/features.pkl','rb').read())
    data = pe.parse_pe_header()
    pe_features = map(lambda x: data[x], features)
    res = clf.predict([list(pe_features)])[0]

    return res

def scan_directory(dirname):
    results = []
    for root,_,files in os.walk(dirname, topdown=False):
        for filename in files:
            if PEParser.is_pefile(os.path.join(root, filename)):
               print('[*]Scanning {}'.format(os.path.join(root, filename)))
               res = scan_file(os.path.join(root, filename))
               print("{}".format(res))
               results.append(res)
    
    return results

if __name__ == '__main__':
    result = scan_file('./samples/sample.exe')

    rs = scan_directory('C:\\Users\\User\\')